import torch
import torch.nn as nn
import numpy as np

########################################################################################################################
wrist_HM70A_labeled_half1_idx = [427, 259, 454, 505, 104, 543, 411, 146, 550, 152,
                                 481, 326, 284, 13, 438, 71]
wrist_HM70A_labeled_half2_idx = [600, 139, 478, 428, 43, 285, 58, 445, 130, 190, 
                                 598, 564, 159, 601, 232, 475]

wrist_HM70A_unlabeled_half1_idx = [622, 164, 556, 372, 339, 177, 250, 540,
             432, 117, 235, 369, 116, 468, 136, 249, 205, 241, 547, 417, 628,
             83, 147, 573, 635, 553, 485, 278, 240, 597, 169, 50, 286, 56, 631,
             484, 179, 329, 165, 639, 461, 470, 609, 618, 185, 617, 388, 581,
             112, 464, 501, 89, 254, 537, 621, 507, 200, 47, 347, 596, 531, 585,
             155, 84, 393, 227, 398, 493, 70, 636, 199, 368, 67, 627, 449,
             408, 322, 167, 558, 168, 75, 310, 23, 576, 103, 574, 480, 119,
             455, 477, 35, 294, 137, 341, 236, 467, 397, 350, 340, 319, 384,
             409, 225, 34, 51, 496, 39, 629, 221, 348, 595, 36, 108, 354, 567,
             309, 395, 380, 568, 298, 557, 196, 24, 215, 61, 74, 458, 386, 9,
             180, 160, 366, 562, 325, 465, 268, 392, 237, 246, 207, 357, 148,
             410, 554, 184, 274, 439, 91, 115, 293, 223, 476, 404, 295, 492, 
             229, 619, 306, 425, 62, 182, 127, 379, 288, 421, 178, 630, 230,
             302, 98, 608, 563, 457, 161, 312, 193, 383, 330, 378, 442, 566,
             436, 599, 508, 40, 2, 216, 443, 174, 96, 406, 296, 626, 586, 187,
             503, 321, 212, 269, 92, 479, 474, 197, 186, 132, 53, 337, 271, 
             346, 374, 624, 343, 66, 258, 578, 437, 242, 514, 512, 472, 37,
             287, 375, 523, 400, 356, 373, 502, 281, 349, 446, 208, 328, 323,
             77, 129, 113, 33, 283, 194]
             
wrist_HM70A_unlabeled_half2_idx = [359, 171, 433, 351, 403, 516, 8, 
             12, 59, 399, 198, 299, 580, 97, 358, 267, 511, 327, 290, 41, 125, 
             100, 15, 353, 462, 10, 82, 389, 575, 524, 602, 120, 422, 483,
             191, 488, 156, 376, 352, 4, 620, 611, 297, 623, 396, 471, 121,
             377, 111, 584, 94, 64, 370, 32, 175, 607, 344, 109, 126, 324,
             577, 22, 335, 605, 301, 228, 316, 73, 490, 345, 456, 361, 110, 
             473, 260, 412, 548, 520, 545, 332, 99, 420, 588, 401, 634, 604, 
             522, 509, 495, 640, 57, 233, 498, 262, 569, 367, 60, 133, 247, 
             434, 334, 142, 218, 248, 593, 63, 592, 52, 579, 124, 405, 289,
             7, 69, 135, 5, 255, 209, 517, 68, 304, 583, 638, 204, 188, 214,
             166, 497, 195, 282, 72, 206, 582, 513, 102, 55, 151, 292, 613,
             625, 149, 131, 272, 202, 533, 541, 213, 3, 362, 243, 16, 263,
             591, 391, 170, 14, 431, 355, 363, 549, 273, 305, 27, 143, 336, 
             266, 594, 300, 158, 128, 331, 499, 95, 606, 544, 253, 452, 538, 
             546, 224, 163, 105, 565, 42, 515, 318, 308, 435, 413, 11, 402,
             633, 521, 429, 303, 571, 418, 30, 276, 614, 342, 226, 86, 238, 
             18, 44, 487, 382, 587, 277, 390, 145, 315, 555, 256, 25, 530,
             172, 534, 234, 415, 140, 559, 17, 333, 385, 26, 423, 482, 157,
             203, 189, 460, 506, 489, 426, 154, 211, 314, 504]

########################################################################################################################
wrist_HM70A_labeled_idx = [427, 259, 454, 505, 104, 543, 411, 146, 550, 152,
                           481, 326, 284, 13, 438, 71, 600, 139, 478, 428,
                           43, 285, 58, 445, 130, 190, 598, 564, 159, 601,
                           232, 475]

wrist_HM70A_unlabeled_idx = [622, 164, 556, 372, 339, 177, 250, 540,
             432, 117, 235, 369, 116, 468, 136, 249, 205, 241, 547, 417, 628,
             83, 147, 573, 635, 553, 485, 278, 240, 597, 169, 50, 286, 56, 631,
             484, 179, 329, 165, 639, 461, 470, 609, 618, 185, 617, 388, 581,
             112, 464, 501, 89, 254, 537, 621, 507, 200, 47, 347, 596, 531, 585,
             155, 84, 393, 227, 398, 493, 70, 636, 199, 368, 67, 627, 449,
             408, 322, 167, 558, 168, 75, 310, 23, 576, 103, 574, 480, 119,
             455, 477, 35, 294, 137, 341, 236, 467, 397, 350, 340, 319, 384,
             409, 225, 34, 51, 496, 39, 629, 221, 348, 595, 36, 108, 354, 567,
             309, 395, 380, 568, 298, 557, 196, 24, 215, 61, 74, 458, 386, 9,
             180, 160, 366, 562, 325, 465, 268, 392, 237, 246, 207, 357, 148,
             410, 554, 184, 274, 439, 91, 115, 293, 223, 476, 404, 295, 492, 
             229, 619, 306, 425, 62, 182, 127, 379, 288, 421, 178, 630, 230,
             302, 98, 608, 563, 457, 161, 312, 193, 383, 330, 378, 442, 566,
             436, 599, 508, 40, 2, 216, 443, 174, 96, 406, 296, 626, 586, 187,
             503, 321, 212, 269, 92, 479, 474, 197, 186, 132, 53, 337, 271, 
             346, 374, 624, 343, 66, 258, 578, 437, 242, 514, 512, 472, 37, 
             287, 375, 523, 400, 356, 373, 502, 281, 349, 446, 208, 328, 323,
             77, 129, 113, 33, 283, 194, 359, 171, 433, 351, 403, 516, 8, 
             12, 59, 399, 198, 299, 580, 97, 358, 267, 511, 327, 290, 41, 125, 
             100, 15, 353, 462, 10, 82, 389, 575, 524, 602, 120, 422, 483,
             191, 488, 156, 376, 352, 4, 620, 611, 297, 623, 396, 471, 121,
             377, 111, 584, 94, 64, 370, 32, 175, 607, 344, 109, 126, 324,
             577, 22, 335, 605, 301, 228, 316, 73, 490, 345, 456, 361, 110, 
             473, 260, 412, 548, 520, 545, 332, 99, 420, 588, 401, 634, 604, 
             522, 509, 495, 640, 57, 233, 498, 262, 569, 367, 60, 133, 247, 
             434, 334, 142, 218, 248, 593, 63, 592, 52, 579, 124, 405, 289,
             7, 69, 135, 5, 255, 209, 517, 68, 304, 583, 638, 204, 188, 214,
             166, 497, 195, 282, 72, 206, 582, 513, 102, 55, 151, 292, 613,
             625, 149, 131, 272, 202, 533, 541, 213, 3, 362, 243, 16, 263,
             591, 391, 170, 14, 431, 355, 363, 549, 273, 305, 27, 143, 336, 
             266, 594, 300, 158, 128, 331, 499, 95, 606, 544, 253, 452, 538, 
             546, 224, 163, 105, 565, 42, 515, 318, 308, 435, 413, 11, 402,
             633, 521, 429, 303, 571, 418, 30, 276, 614, 342, 226, 86, 238, 
             18, 44, 487, 382, 587, 277, 390, 145, 315, 555, 256, 25, 530,
             172, 534, 234, 415, 140, 559, 17, 333, 385, 26, 423, 482, 157,
             203, 189, 460, 506, 489, 426, 154, 211, 314, 504]


########################################################################################################################
wrist_HM70A_train_idx = [427, 259, 454, 505, 104, 543, 411, 146, 550, 152, 481, 326, 284,
             13, 438, 71, 600, 139, 478, 428, 43, 285, 58, 445, 130, 190, 598,
             564, 159, 601, 232, 475, 622, 164, 556, 372, 339, 177, 250, 540,
             432, 117, 235, 369, 116, 468, 136, 249, 205, 241, 547, 417, 628,
             83, 147, 573, 635, 553, 485, 278, 240, 597, 169, 50, 286, 56, 631,
             484, 179, 329, 165, 639, 461, 470, 609, 618, 185, 617, 388, 581,
             112, 464, 501, 89, 254, 537, 621, 507, 200, 47, 347, 596, 531, 585,
             155, 84, 393, 227, 398, 493, 70, 636, 199, 368, 67, 627, 449,
             408, 322, 167, 558, 168, 75, 310, 23, 576, 103, 574, 480, 119,
             455, 477, 35, 294, 137, 341, 236, 467, 397, 350, 340, 319, 384,
             409, 225, 34, 51, 496, 39, 629, 221, 348, 595, 36, 108, 354, 567,
             309, 395, 380, 568, 298, 557, 196, 24, 215, 61, 74, 458, 386, 9,
             180, 160, 366, 562, 325, 465, 268, 392, 237, 246, 207, 357, 148,
             410, 554, 184, 274, 439, 91, 115, 293, 223, 476, 404, 295, 492, 
             229, 619, 306, 425, 62, 182, 127, 379, 288, 421, 178, 630, 230,
             302, 98, 608, 563, 457, 161, 312, 193, 383, 330, 378, 442, 566,
             436, 599, 508, 40, 2, 216, 443, 174, 96, 406, 296, 626, 586, 187,
             503, 321, 212, 269, 92, 479, 474, 197, 186, 132, 53, 337, 271, 
             346, 374, 624, 343, 66, 258, 578, 437, 242, 514, 512, 472, 37, 
             287, 375, 523, 400, 356, 373, 502, 281, 349, 446, 208, 328, 323,
             77, 129, 113, 33, 283, 194, 359, 171, 433, 351, 403, 516, 8, 
             12, 59, 399, 198, 299, 580, 97, 358, 267, 511, 327, 290, 41, 125, 
             100, 15, 353, 462, 10, 82, 389, 575, 524, 602, 120, 422, 483,
             191, 488, 156, 376, 352, 4, 620, 611, 297, 623, 396, 471, 121,
             377, 111, 584, 94, 64, 370, 32, 175, 607, 344, 109, 126, 324,
             577, 22, 335, 605, 301, 228, 316, 73, 490, 345, 456, 361, 110, 
             473, 260, 412, 548, 520, 545, 332, 99, 420, 588, 401, 634, 604, 
             522, 509, 495, 640, 57, 233, 498, 262, 569, 367, 60, 133, 247, 
             434, 334, 142, 218, 248, 593, 63, 592, 52, 579, 124, 405, 289,
             7, 69, 135, 5, 255, 209, 517, 68, 304, 583, 638, 204, 188, 214,
             166, 497, 195, 282, 72, 206, 582, 513, 102, 55, 151, 292, 613,
             625, 149, 131, 272, 202, 533, 541, 213, 3, 362, 243, 16, 263,
             591, 391, 170, 14, 431, 355, 363, 549, 273, 305, 27, 143, 336, 
             266, 594, 300, 158, 128, 331, 499, 95, 606, 544, 253, 452, 538, 
             546, 224, 163, 105, 565, 42, 515, 318, 308, 435, 413, 11, 402,
             633, 521, 429, 303, 571, 418, 30, 276, 614, 342, 226, 86, 238, 
             18, 44, 487, 382, 587, 277, 390, 145, 315, 555, 256, 25, 530,
             172, 534, 234, 415, 140, 559, 17, 333, 385, 26, 423, 482, 157,
             203, 189, 460, 506, 489, 426, 154, 211, 314, 504]

wrist_HM70A_valid_idx = [637, 78, 19, 360, 441, 264, 364, 444, 173, 603, 210, 371, 632,
             552, 424, 114, 317, 245, 251, 107, 313, 394, 463, 217, 525, 231,
             510, 138, 570, 162, 48, 31, 529, 118, 265, 6, 261, 79, 38, 183,
             219, 416, 153, 610, 451, 491, 81, 85, 561, 106, 387, 407, 222,
             381, 279, 20, 280, 123, 88, 519, 447, 560, 244, 612, 311, 453,
             21, 0, 518, 539, 141, 122, 49, 448, 616, 65, 466, 469, 275, 535,
             181, 526, 90, 176, 291, 590, 486, 93, 87, 192, 320, 414, 615,
             500, 101, 257, 450, 252, 54, 46, 150, 338, 201, 532, 365, 494,
             134, 29, 551, 45, 76, 528, 440, 270, 144, 572, 419, 430, 536,
             307, 459, 239, 542, 589, 220, 1, 28, 527, 80]

########################################################################################################################
forearm_HM70A_train_idx = [123, 73, 41, 112, 131, 57, 125, 111, 139, 140, 67, 138, 129, 47, 150,
             97, 147, 8, 18, 158, 132, 83, 74, 12, 2, 75, 50, 40, 128, 44, 58, 126,
             56, 100, 89, 92, 62, 86, 10, 71, 34, 94, 148, 91, 31, 17, 59, 121, 11,
             104, 127, 4, 120, 81, 96, 103, 159, 161, 38, 154, 160, 88, 79, 32, 136,
             106, 36, 3, 143, 99, 119, 156, 151, 7, 63, 105, 95, 42, 22, 68, 55, 118,
             113, 21, 0, 6, 37, 69, 27, 13, 33, 49, 98, 72, 65, 133, 107, 19, 114,
             23, 52, 53, 145, 5, 90, 48, 130, 85, 35, 78, 146, 102, 93, 87, 115, 64,
             70, 149, 153, 137, 152, 116, 108, 101, 9, 157, 66, 124, 43]

forearm_HM70A_valid_idx = [135, 54, 46, 155, 82, 20, 109, 25, 134, 29, 39, 142, 84, 45, 76, 16,
             14, 122, 144, 60, 24, 51, 61, 110, 30, 77, 26, 117, 1, 28, 15, 80, 141]

########################################################################################################################
wrist_miniSONO_train_idx = [11, 164, 288, 118, 277, 64, 270, 24, 41, 45, 101, 28, 75, 27, 74, 201, 
                            110, 240, 25, 107, 307, 272, 148, 309, 20, 174, 243, 139, 16, 249, 175, 
                            276, 188, 301, 264, 22, 14, 244, 257, 260, 162, 165, 36, 197, 13, 73, 253, 
                            178, 281, 131, 3, 215, 150, 217, 128, 35, 238, 48, 67, 170, 43, 2, 239, 271, 
                            232, 171, 308, 77, 283, 306, 100, 70, 237, 241, 251, 34, 76, 199, 153, 141, 
                            159, 115, 225, 78, 39, 65, 86, 72, 124, 47, 180, 137, 221, 106, 192, 252, 38, 
                            224, 216, 173, 54, 62, 126, 147, 245, 296, 68, 214, 205, 193, 125, 136, 302, 
                            133, 191, 259, 236, 209, 112, 294, 184, 297, 284, 17, 152, 105, 4, 265, 258, 
                            204, 263, 229, 130, 208, 88, 255, 142, 167, 83, 1, 127, 248, 299, 269, 242, 149, 
                            198, 49, 207, 300, 82, 122, 144, 71, 268, 23, 50, 10, 169, 6, 280, 212, 177, 292, 
                            156, 33, 46, 146, 213, 230, 279, 108, 85, 37, 210, 161, 18, 102, 44, 223, 63, 310, 
                            190, 92, 95, 129, 275, 273, 176, 305, 246, 57, 80, 116, 15, 40, 30, 200, 117, 286, 
                            168, 206, 53, 7, 99, 160, 220, 202, 183, 21, 186, 233, 12, 140, 222, 278, 132, 59, 
                            84, 185, 203, 196, 138, 31, 114, 166, 91, 267, 187, 93, 211, 172, 219, 55, 285, 51, 
                            32, 94, 266, 226, 104, 135, 143, 189, 134, 121, 9, 289]

wrist_miniSONO_valid_idx = [0, 256, 5, 261, 262, 8, 145, 274, 19, 151, 26, 154, 155, 29, 157, 158, 282, 287, 
                            290, 163, 291, 293, 295, 42, 298, 303, 304, 179, 52, 181, 182, 56, 58, 60, 61, 66, 
                            194, 195, 69, 79, 81, 87, 89, 90, 218, 247, 96, 97, 98, 227, 228, 103, 231, 234, 235, 
                            109, 111, 113, 119, 120, 250, 123, 254]

########################################################################################################################
forearm_miniSONO_train_idx = [86, 164, 155, 78, 177, 6, 117, 123, 98, 95, 47, 162, 108, 128, 84, 165, 75, 113, 36,
                              99, 37, 136, 133, 14, 180, 11, 3, 100, 0, 4, 102, 188, 9, 10, 171, 22, 132, 138, 66, 
                              172, 15, 187, 92, 110, 163, 69, 156, 190, 167, 56, 20, 61, 18, 139, 106, 70, 122, 19, 
                              143, 88, 109, 134, 23, 157, 25, 173, 44, 181, 185, 115, 144, 42, 120, 16, 116, 151, 
                              184, 148, 142, 101, 94, 17, 145, 96, 40, 83, 85, 52, 93, 169, 97, 8, 24, 166, 111, 
                              160, 125, 121, 158, 31, 161, 126, 189, 107, 182, 58, 50, 38, 28, 32, 170, 57, 175, 5, 
                              147, 77, 119, 29, 127, 74, 91, 13, 41, 1, 146, 149, 39, 112, 72, 67, 21, 131, 49, 135, 
                              114, 81, 64, 124, 62, 68, 118, 129, 51, 183, 153, 46, 141, 87, 90, 150, 89, 27, 34]

forearm_miniSONO_valid_idx = [2, 130, 7, 137, 12, 140, 152, 26, 154, 30, 159, 33, 35, 168, 43, 45, 174,
                              48, 176, 178, 179, 53, 54, 55, 186, 59, 60, 63, 65, 71, 73, 76, 79, 80,
                              82, 103, 104, 105]
'''
########################################################################################################################
wrist_t = np.array(wrist_miniSONO_train_idx) + 641
wrist_v = np.array(wrist_miniSONO_valid_idx) + 641

wrist_train = wrist_HM70A_train_idx + wrist_t.tolist()
wrist_valid = wrist_HM70A_valid_idx + wrist_v.tolist()

########################################################################################################################
forearm_t = np.array(forearm_miniSONO_train_idx) + 162
forearm_v = np.array(forearm_miniSONO_valid_idx) + 162

forearm_train = forearm_HM70A_train_idx + forearm_t.tolist()
forearm_valid = forearm_HM70A_valid_idx + forearm_v.tolist()
'''

'''
########################################################################################################################
train_M = [114, 71, 74, 147, 86, 120, 70, 97, 166, 115, 58, 94, 75, 56, 118, 176, 133,
           149, 129, 47, 139, 102, 98, 89, 135, 126, 127, 12, 62, 57, 66, 179, 83, 160,
           143, 18, 96, 8, 155, 11, 154, 112, 165, 103, 41, 107, 44, 2, 164, 73, 177, 157,
           100, 95, 130, 178, 59, 113, 156, 158, 40, 91, 50, 170, 10, 34, 172, 148, 99, 31,
           17, 180, 168, 142, 4, 131, 105, 174, 128, 79, 140, 38, 104, 32, 153, 146, 67,
           36, 81, 121, 3, 92, 124, 138, 137, 169, 88, 7, 63, 48, 106, 42, 22, 68, 55, 171,
           111, 21, 0, 6, 37, 69, 27, 13, 33, 49, 123, 145, 72, 65, 150, 85, 19, 136, 23, 52,
           53, 162, 5, 90, 116, 35, 78, 119, 93, 87, 64, 167, 151, 125, 108, 101, 9, 175, 43]

valid_M = [152, 54, 46, 132, 173, 82, 20, 109, 25, 134, 29, 39, 159, 84, 45, 76, 16, 14, 122,
           144, 60, 163, 24, 51, 61, 110, 30, 77, 26, 117, 1, 161, 28, 15, 80, 141]

########################################################################################################################
train_U = [126, 99, 130, 115, 154, 124, 89, 198, 96, 147, 56, 50, 194, 98, 74, 180, 2, 173, 18,
           58, 145, 59, 208, 22, 199, 95, 214, 215, 105, 160, 143, 92, 111, 41, 188, 157, 179, 11,
           12, 178, 71, 53, 70, 155, 177, 146, 120, 151, 169, 135, 112, 8, 62, 162, 83, 181, 176,
           149, 193, 129, 104, 148, 100, 172, 113, 73, 187, 40, 128, 138, 63, 47, 44, 66, 97, 213,
           189, 114, 57, 166, 86, 210, 103, 13, 205, 121, 10, 34, 170, 102, 131, 31, 17, 133, 191,
           75, 206, 171, 4, 159, 137, 140, 156, 79, 139, 38, 136, 91, 200, 32, 195, 175, 67, 36,
           107, 81, 85, 118, 185, 106, 3, 127, 94, 153, 167, 165, 168, 123, 204, 88, 7, 48, 142,
           42, 212, 68, 55, 207, 21, 0, 6, 37, 69, 27, 216, 33, 197, 49, 201, 72, 65, 19, 190,
           23, 52, 196, 5, 90, 116, 35, 78, 119, 93, 87, 64, 202, 158, 182, 125, 108, 101, 9, 211]

valid_U = [43, 183, 54, 46, 132, 209, 150, 152, 82, 20, 109, 25, 134, 29, 186, 39, 192, 164, 84,
           45, 76, 16, 184, 14, 122, 144, 60, 163, 174, 24, 51, 61, 110, 203, 30, 77, 26, 117, 1, 161,
           28, 15, 80, 141]

########################################################################################################################
elbow_t = np.array(elbow_train_idx) + 641
M_t = np.array(train_M) + 803
U_t = np.array(train_U) + 984

all_train = wrist_train_idx + elbow_t.tolist() + M_t.tolist() + U_t.tolist()

elbow_v = np.array(elbow_valid_idx) + 641
M_v = np.array(valid_M) + 803
U_v = np.array(valid_U) + 984

all_valid =  wrist_valid_idx + elbow_v.tolist() + M_v.tolist() + U_v.tolist()


median_train = wrist_train_idx + elbow_t.tolist() + M_t.tolist()
median_valid = wrist_valid_idx + elbow_v.tolist() + M_v.tolist()
'''
########################################################################################################################
class DiceLoss(nn.Module):
    def __init__(self):
        super(DiceLoss, self).__init__()

    def forward(self, pred, target):
        
        smooth = 1e-6
        # m1=pred.flatten()
        # m2=target.flatten()
        # intersection = (m1 * m2)

        # score=1-((2. * torch.sum(intersection) + smooth) / (torch.sum(m1) + torch.sum(m2) + smooth))
        # #score=1-((2. * torch.sum(intersection) + smooth) / (torch.sum(m1*m1) + torch.sum(m2*m2) + smooth))
                
        num = target.shape[0]
        m1 = pred.view(num, -1)
        m2 = target.view(num, -1)
        intersection=torch.mul(m1,m2)
        score = 1-torch.sum((2. * torch.sum(intersection,dim=1) + smooth) / (torch.sum(m1,dim=1) + torch.sum(m2,dim=1) + smooth))/num
        
        # for squared
        ## score = 1-torch.sum((2. * torch.sum(intersection,dim=1) + smooth) / (torch.sum(m1*m1,dim=1) + torch.sum(m2*m2,dim=1) + smooth))/num
        
        return score